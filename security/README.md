# Security

## Operator

Deploy the operator

```
oc apply -f 01-operator/
```

## Install Keycloak / RH-SSO

Install the RH-SSO using the supplied script:

```
./02-install-keycloak.sh
```

Log in to the Keycloak console with the credentials generated by the script.
Load the `03-external.json` and `04-external.json` realms with predefined users.

Get the public key of the Keycloak route / the CA which signed it and create a secret with it. 
Also create the keystore with it, we will use it later.
OpenSSL can be used to get the certificate:

```
openssl s_client -showcerts -connect sso-myproject.apps.jscholz.rhmw-integrations.net:443 -servername sso-myproject.apps.jscholz.rhmw-integrations.net
```

Keytool to create the keystore:

```
keytool -importcert -keystore oauth.truststore -file oauth.crt
```

## Kafka

Deploy Kafka with OAuth authentication.
Check the `05-kafka-oauth.yaml` file and fix the secrets to the certificates if needed.
Afterwards create the Kafka cluster:

```
oc apply -f 05-kafka-oauth.yaml
```

## Internal clients

Deploy the internal clients:

```
oc apply -f 06-deployment.yaml
```

Check that it works

## Kafka Connect

Show the Kafka Connect YAML and deploy it:

```
oc apply -f 07-kafka-connect.yaml
```

## Custom certificates

Go to `08-custom-certificates` and generate new custom server certificates and load them as secrets.

Deploy Kafka using it:

```
oc apply -f 09-kafka-custom-cert.yaml
```

Notice the change in the file:

```yaml
        configuration:
          brokerCertChainAndKey:
            secretName: custom-cert-external
            certificate: tls.crt
            key: tls.key
```

## User ACL

Look at the `10-external-user.yaml` and deploy it:

```
oc apply -f 10-external-user.yaml
```

Use the user in the external client to connect to the cluster.

## Network policies

Update the Kafka resource with the new network policies configuration_

```yaml
        networkPolicyPeers:
          - podSelector:
              matchLabels:
                app: kafka-consumer
          - podSelector:
              matchLabels:
                app: kafka-producer
```

```
oc apply -f 11-kafka-network-polcies.yaml
```

Restart the Hello World consumers / producers and see how they cannot connect.
Change the network policies and see how the connection is allowed.